<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Maison Vintage{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="{{ asset('images/logo.png') }}">

    {# DÃ©sactive les visites Turbo -> rechargement complet #}
    <meta name="turbo-visit-control" content="reload">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    {# Polices #}
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    {# CSS compilÃ© (depuis Sass) #}
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">
    {% block stylesheets %}{% endblock %}
</head>
<body class="bg-light d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid align-items-center px-3 px-lg-4">

        {# GAUCHE : Brand #}
        <a class="navbar-brand d-flex align-items-center" href="{{ path('home') }}">
            <span class="brand-logo me-2">
                <img src="{{ asset('images/logo.png') }}" alt="Maison Vintage">
            </span>
            <span class="fw-bold">Maison Vintage</span>
        </a>

        {# Burger #}
        <button class="navbar-toggler ms-auto" type="button"
                data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Basculer la navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        {# CONTENU PLIABLE #}
        <div class="collapse navbar-collapse w-100 mv-navline" id="mainNav">

            {# MILIEU : Menu + Recherche (centrÃ©s) #}
            <div class="mv-nav-middle">

                <ul class="navbar-nav justify-content-center">
                    <li class="nav-item"><a class="nav-link" href="{{ path('home') }}">Accueil</a></li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navCategories" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            CatÃ©gories
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navCategories">
                            {% for cat in categories() %}
                                <li><a class="dropdown-item" href="{{ path('categorie_show', { slug: cat.slug }) }}">{{ cat.nom }}</a></li>
                            {% else %}
                                <li><span class="dropdown-item-text text-muted">Aucune catÃ©gorie</span></li>
                            {% endfor %}
                        </ul>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="{{ path('victime_succes') }}">Victime de son succÃ¨s</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ path('nouveau_cocon') }}">Nouveau Cocon</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ path('contact') }}">Contact</a></li>
                </ul>

                <form
                    class="d-flex position-relative mx-lg-2"
                    role="search"
                    action="{{ path('search') }}"
                    method="get"
                    autocomplete="off"
                    aria-label="Recherche d'articles"
                    id="mv-search-form"
                >
                    <label for="q" class="visually-hidden">Rechercher un article</label>
                    <div class="input-group input-group-sm w-100">
                        <input
                            id="q" name="q" type="search" class="form-control"
                            placeholder="Rechercher un article (ex. chaise)â€¦"
                            value="{{ app.request.get('q') }}"
                            aria-autocomplete="list" aria-controls="mv-suggest"
                            aria-expanded="false" aria-haspopup="listbox"
                            autocapitalize="off" autocorrect="off" spellcheck="false"
                            autocomplete="off" inputmode="search"
                        >
                        <button class="btn btn-outline-light" type="submit" aria-label="Lancer la recherche">ðŸ”Ž</button>
                    </div>

                    <div id="mv-suggest" class="list-group position-absolute shadow"
                         role="listbox" aria-label="Suggestions de recherche"
                         style="top:100%;left:0;right:0;z-index:1050;display:none;max-height:260px;overflow:auto;"></div>
                </form>
            </div>

            {# DROITE : Panier + Compte #}
            <ul class="navbar-nav mv-nav-right">
                {% set _cart = app.session.get('cart') ?? {} %}
                {% set _count = 0 %}
                {% for _id, _qty in _cart %}{% set _count = _count + _qty %}{% endfor %}

                <li class="nav-item me-2">
                    <a class="nav-link position-relative" href="{{ path('cart_show') }}">
                        ðŸ›’ Panier
                        <span id="cart-count"
                              class="badge bg-light text-dark ms-1{% if _count == 0 %} d-none{% endif %}"
                              data-count="{{ _count|default(0) }}">
                            {{ _count|default(0) }}
                        </span>
                    </a>
                </li>

                {% if app.user %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navAccount" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Mon compte
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navAccount">
                            <li><a class="dropdown-item" href="{{ path('app_account_profile') }}">Mes infos</a></li>
                            <li><a class="dropdown-item" href="{{ path('account_address_index') }}">Mes adresses</a></li>
                            <li><a class="dropdown-item" href="{{ path('app_account_password') }}">Mot de passe</a></li>
                            <li><a class="dropdown-item" href="{{ path('app_account_orders') }}">Mes commandes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="{{ path('app_logout') }}">Se dÃ©connecter</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item"><a class="nav-link" href="{{ path('app_login') }}">Se connecter</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ path('app_register') }}">CrÃ©er un compte</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

{# FLASHES #}
<div class="container mt-3" style="max-width:1100px;">
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ type == 'danger' ? 'danger' : (type == 'success' ? 'success' : (type == 'warning' ? 'warning' : 'info')) }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
            </div>
        {% endfor %}
    {% endfor %}
</div>

<main class="container py-4 flex-grow-1">
    {% block body %}{% endblock %}
</main>

<footer class="bg-dark text-white-50 py-3 mt-auto">
    <div class="container d-flex justify-content-between small">
        <span>&copy; {{ "now"|date("Y") }} Maison Vintage</span>
        <span>Fait avec Symfony</span>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block javascripts %}
    {% block importmap %}{{ importmap('app') }}{% endblock %}

    {# Autocomplete â€” liens au format canonique id-slug (FIX) #}
    <script>
        (function () {
            const form = document.getElementById('mv-search-form');
            const input = document.getElementById('q');
            const box = document.getElementById('mv-suggest');
            if (!form || !input || !box) return;

            let t = null, controller = null, activeIndex = -1;

            function hideBox(){ box.style.display='none'; box.innerHTML=''; input.setAttribute('aria-expanded','false'); activeIndex=-1; }
            function showBox(){ box.style.display='block'; input.setAttribute('aria-expanded','true'); }

            // On demande Ã  Twig une URL VALIDE, puis on remplace le segment "0-PLACEHOLDER"
            const CANONICAL_STUB = "{{ path('article_show', { id: 0, slug: 'PLACEHOLDER' }) }}"; // ex: "/article/0-PLACEHOLDER"
            function buildCanonicalHref(id, slug){
                const repl = String(id) + '-' + encodeURIComponent(slug || '');
                return CANONICAL_STUB.replace('/0-PLACEHOLDER', '/' + repl);
            }

            // Routes de secours (by id, legacy slug) construites sur le mÃªme principe
            const BYID_STUB = "{{ path('article_show_by_id', { id: 0 }) }}"; // "/article/id/0"
            function buildByIdHref(id){ return BYID_STUB.replace('/0', '/' + String(id)); }

            const LEGACY_STUB = "{{ path('article_show_legacy', { slug: 'PLACEHOLDER' }) }}"; // "/article/PLACEHOLDER"
            function buildLegacyHref(slug){ return LEGACY_STUB.replace('PLACEHOLDER', encodeURIComponent(slug || '')); }

            function hrefFor(item){
                if (item && item.id != null) return buildCanonicalHref(item.id, item.slug);
                if (item && item.id != null) return buildByIdHref(item.id);
                return buildLegacyHref(item?.slug);
            }

            function buildItemHtml(item, selected){
                const cls='list-group-item list-group-item-action d-flex justify-content-between align-items-center'+(selected?' active':'');
                const href = hrefFor(item);
                return `<a role="option" class="${cls}" href="${href}" aria-selected="${selected?'true':'false'}">
                          <span>${item.titre ?? ''}</span>
                          <small class="text-muted ms-2">${item.cat ?? ''}</small>
                        </a>`;
            }
            function renderList(items){
                if(!Array.isArray(items)||items.length===0){ hideBox(); return; }
                box.innerHTML = items.map((it,i)=>buildItemHtml(it,i===activeIndex)).join('');
                showBox();
            }
            function debounceFetch(q){
                if(t) clearTimeout(t);
                t=setTimeout(async ()=>{
                    if(controller) controller.abort();
                    controller = new AbortController();
                    try{
                        const url = `{{ path('search_autocomplete') }}?q=`+encodeURIComponent(q);
                        const resp = await fetch(url, { signal: controller.signal, headers:{'Accept':'application/json'}});
                        if(!resp.ok){ hideBox(); return; }
                        const data = await resp.json();
                        // data attendu: [{id, slug, titre, cat}, ...]
                        renderList(data);
                    }catch(e){ hideBox(); }
                },150);
            }
            input.addEventListener('input', ()=>{
                const q=input.value.trim();
                if(q.length<2){ hideBox(); return; }
                debounceFetch(q);
            });
            input.addEventListener('keydown',(e)=>{
                const items=box.querySelectorAll('[role="option"]');
                if(box.style.display!=='block'||items.length===0) return;
                if(e.key==='ArrowDown'){ e.preventDefault(); activeIndex=(activeIndex+1)%items.length; }
                else if(e.key==='ArrowUp'){ e.preventDefault(); activeIndex=(activeIndex-1+items.length)%items.length; }
                else if(e.key==='Enter'){ if(activeIndex>=0&&activeIndex<items.length){ e.preventDefault(); window.location.href=items[activeIndex].getAttribute('href'); } }
                else if(e.key==='Escape'){ hideBox(); }
            });
            document.addEventListener('click',(e)=>{ if(!box.contains(e.target)&&e.target!==input){ hideBox(); }});
            window.addEventListener('resize', hideBox);
            input.addEventListener('blur',()=>setTimeout(hideBox,120));
            form.addEventListener('submit',(e)=>{ if(input.value.trim()===''){ e.preventDefault(); hideBox(); }});
        })();
    </script>

    {# Badge Panier rÃ©actif #}
    <script>
        (function () {
            const el = document.getElementById('cart-count');
            if (!el) return;

            function render(count) {
                const n = Math.max(0, parseInt(count || 0, 10) || 0);
                el.textContent = n;
                el.dataset.count = String(n);
                if (n > 0) {
                    el.classList.remove('d-none');
                } else {
                    el.classList.add('d-none');
                }
            }

            // Init depuis l'attribut data-count
            render(el.dataset.count);

            // 1) Ã‰vÃ©nement custom
            document.addEventListener('cart:updated', (e) => {
                const next = e?.detail?.count ?? 0;
                render(next);
                try { localStorage.setItem('mv-cart-count', String(next)); } catch (_) {}
            });

            // 2) Sync inter-onglets
            try {
                const cached = localStorage.getItem('mv-cart-count');
                if (cached !== null) { render(cached); }
                window.addEventListener('storage', (e) => {
                    if (e.key === 'mv-cart-count') {
                        render(e.newValue ?? 0);
                    }
                });
            } catch (_) {}
        })();
    </script>
{% endblock %}
</body>
</html>
