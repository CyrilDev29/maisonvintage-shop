{% extends 'base.html.twig' %}

{% block title %}{{ article.titre }} — Maisonvintage{% endblock %}

{% block body %}
    <section class="container" style="max-width:1100px;margin:2rem auto;padding:0 1rem;">
        <nav style="margin-bottom:1rem;font-size:.95rem;">
            <a href="{{ path('home') ?? '/' }}">Accueil</a>
            &nbsp;›&nbsp;
            <a href="{{ path('categorie_show', {slug: article.categorie.slug}) }}">{{ article.categorie.nom }}</a>
            &nbsp;›&nbsp;
            <span>{{ article.titre }}</span>
        </nav>

        {# --- Détermine la source de l'image principale (Vich -> 1ère galerie -> placeholder) --- #}
        {% set mainSrc = vich_uploader_asset(article, 'imageFile')
            ?? (article.images|length > 0 ? vich_uploader_asset(article.images|first, 'file') : asset('images/placeholder.png')) %}

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
            <div>
                <div id="product-main-wrap" style="width:100%;border:1px solid #eee;border-radius:8px;background:#fff;overflow:hidden;">
                    <img id="product-main"
                         src="{{ mainSrc }}"
                         alt="{{ article.titre }}"
                         style="width:100%;height:auto;display:block;max-height:520px;object-fit:contain;"
                         loading="eager">
                </div>

                {# --- Miniatures (image principale + images de galerie) --- #}
                {% set thumbs = [] %}
                {% if vich_uploader_asset(article, 'imageFile') %}
                    {% set thumbs = thumbs|merge([ vich_uploader_asset(article, 'imageFile') ]) %}
                {% endif %}
                {% for img in article.images %}
                    {% set thumbs = thumbs|merge([ vich_uploader_asset(img, 'file') ]) %}
                {% endfor %}

                {% if thumbs|length > 0 %}
                    <div class="thumbs" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;">
                        {% for src in thumbs %}
                            {% if src %}
                                <button class="thumb-btn"
                                        type="button"
                                        data-src="{{ src }}"
                                        style="border:1px solid #e5e5e5;border-radius:6px;background:#fff;padding:0;cursor:pointer;">
                                    <img src="{{ src }}"
                                         alt="Aperçu {{ loop.index }}"
                                         style="width:86px;height:86px;object-fit:cover;display:block;border-radius:6px;"
                                         loading="lazy">
                                </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div>
                <h1 style="margin:.25rem 0 1rem 0;">{{ article.titre }}</h1>

                {% if article.prix is not null %}
                    <div style="font-size:1.5rem;font-weight:700;margin-bottom:1rem;">
                        {{ article.prix|number_format(2, ',', ' ') }} €
                    </div>
                {% endif %}

                {% if article.quantity is not null %}
                    <div style="margin-bottom:.75rem;color:#444;">
                        Quantité disponible : {{ article.quantity }}
                    </div>
                {% endif %}

                {# --- Dimensions et poids --- #}
                <div style="margin:1rem 0;color:#555;line-height:1.5;">
                    {% if article.weightKg %}
                        <div>Poids : {{ (article.weightKg + 0)|number_format(3, ',', ' ') }} kg</div>
                    {% endif %}
                    {% if article.lengthCm %}
                        <div>Longueur : {{ (article.lengthCm + 0)|number_format(1, ',', ' ') }} cm</div>
                    {% endif %}
                    {% if article.widthCm %}
                        <div>Largeur : {{ (article.widthCm + 0)|number_format(1, ',', ' ') }} cm</div>
                    {% endif %}
                    {% if article.heightCm %}
                        <div>Hauteur : {{ (article.heightCm + 0)|number_format(1, ',', ' ') }} cm</div>
                    {% endif %}
                </div>

                {% if article.description %}
                    <div style="margin:1rem 0 1.5rem 0;line-height:1.6;">
                        {{ article.description|nl2br }}
                    </div>
                {% endif %}

                {# --- Bloc "Ajouter au panier" --- #}
                {% if article.quantity is defined and article.quantity > 0 %}
                    <form action="{{ path('cart_add', {id: article.id}) }}" method="post" style="margin:1rem 0 1.5rem 0;">
                        {% if article.quantity > 1 %}
                            <label for="qty" style="display:inline-block;margin-right:.5rem;">Quantité</label>
                            <input id="qty" name="qty" type="number" value="1" min="1" max="{{ article.quantity }}"
                                   style="width:90px;padding:.4rem;border:1px solid #ccc;border-radius:6px;margin-right:.5rem;">
                        {% else %}
                            <input type="hidden" name="qty" value="1">
                        {% endif %}

                        <button type="submit"
                                style="padding:.6rem 1rem;border:1px solid #222;border-radius:8px;background:#222;color:#fff;">
                            Ajouter au panier
                        </button>
                    </form>
                {% else %}
                    <div style="margin:1rem 0 1.5rem 0;color:#a00;font-weight:600;">
                        Rupture de stock
                    </div>
                {% endif %}

                <a href="{{ path('categorie_show', {slug: article.categorie.slug}) }}"
                   style="display:inline-block;padding:.6rem 1rem;border:1px solid #222;border-radius:8px;text-decoration:none;">
                    ← Retour à {{ article.categorie.nom }}
                </a>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainImg = document.getElementById('product-main');
            document.querySelectorAll('.thumb-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const src = this.getAttribute('data-src');
                    if (!src || !mainImg) return;

                    //  transition visuelle en cas de chagement
                    mainImg.style.opacity = '0.2';
                    const img = new Image();
                    img.onload = function () {
                        mainImg.src = src;
                        mainImg.style.opacity = '1';
                    };
                    img.src = src;
                });
            });
        });
    </script>
{% endblock %}
