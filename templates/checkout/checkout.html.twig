{# templates/checkout/checkout.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Checkout — Maisonvintage{% endblock %}

{% block body %}
    <section class="container" style="max-width:1100px;margin:2rem auto;padding:0 1rem;">
        <h1>Récapitulatif</h1>

        <p class="text-muted">Connecté en tant que <strong>{{ app.user.userIdentifier }}</strong></p>

        <table class="table align-middle">
            <thead>
            <tr>
                <th style="width:100px;">Photo</th>
                <th>Article</th>
                <th class="text-end">Prix</th>
                <th class="text-center">Qté</th>
                <th class="text-end">Sous-total</th>
            </tr>
            </thead>
            <tbody>
            {% for line in items %}
                {% set _slug = line.article.slug ?? null %}
                {% set mainSrc = vich_uploader_asset(line.article, 'imageFile')
                    ?? (line.article.images|length > 0
                    ? vich_uploader_asset(line.article.images|first, 'file')
                    : asset('images/placeholder.png')) %}

                <tr>
                    <td>
                        <img src="{{ mainSrc }}"
                             alt="{{ line.article.titre }}"
                             style="width:80px;height:80px;object-fit:cover;border-radius:6px;">
                    </td>
                    <td>
                        {% if _slug is not empty %}
                            <a href="{{ path('article_show', { slug: _slug }) }}">{{ line.article.titre }}</a>
                        {% else %}
                            <a href="{{ path('article_show', { id: line.article.id }) }}">{{ line.article.titre }}</a>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ line.price|number_format(2, ',', ' ') }} €</td>
                    <td class="text-center">{{ line.qty }}</td>
                    <td class="text-end">{{ line.subtotal|number_format(2, ',', ' ') }} €</td>
                </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <th colspan="4" class="text-end">Total</th>
                <th class="text-end">{{ total|number_format(2, ',', ' ') }} €</th>
            </tr>
            </tfoot>
        </table>

        <div class="d-flex justify-content-between mt-4">
            <a href="{{ path('cart_show') }}" class="btn btn-outline-secondary">← Retour au panier</a>

            {# Formulaire de validation de commande #}
            <form method="post" action="{{ path('checkout_confirm') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('checkout_confirm') }}">
                <button type="submit" class="btn btn-primary btn-lg">
                    ✅ Valider ma commande
                </button>
            </form>
        </div>
    </section>
{% endblock %}
