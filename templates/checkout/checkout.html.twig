{# templates/checkout/checkout.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Checkout — Maisonvintage{% endblock %}

{% block body %}
    <section class="container" style="max-width:1100px;margin:2rem auto;padding:0 1rem;">
        <h1>Récapitulatif</h1>

        <p class="text-muted">Connecté en tant que <strong>{{ app.user.userIdentifier }}</strong></p>

        {# Adresse de livraison #}
        <div class="card mb-3">
            <div class="card-body">
                <h2 class="h6 mb-2">Adresse de livraison</h2>

                {% if selectedAddress %}
                    <div>
                        {{ selectedAddress.fullName }}<br>
                        {{ selectedAddress.line1 }}{% if selectedAddress.line2 %}, {{ selectedAddress.line2 }}{% endif %}<br>
                        {{ selectedAddress.postalCode }} {{ selectedAddress.city }} — {{ selectedAddress.country }}
                    </div>
                    <a class="btn btn-link p-0 mt-2" href="{{ path('checkout_address') }}">modifier</a>
                {% else %}
                    <p class="text-muted mb-2">Aucune adresse de livraison sélectionnée.</p>
                    <a class="btn btn-primary btn-sm" href="{{ path('checkout_address') }}">choisir une adresse</a>
                {% endif %}
            </div>
        </div>

        {# Adresse de facturation #}
        <div class="card mb-3">
            <div class="card-body">
                <h2 class="h6 mb-2">Adresse de facturation</h2>

                {% if billingSame and selectedAddress %}
                    <div>
                        {{ selectedAddress.fullName }}<br>
                        {{ selectedAddress.line1 }}{% if selectedAddress.line2 %}, {{ selectedAddress.line2 }}{% endif %}<br>
                        {{ selectedAddress.postalCode }} {{ selectedAddress.city }} — {{ selectedAddress.country }}
                    </div>
                    <a class="btn btn-link p-0 mt-2" href="{{ path('checkout_address') }}">changer</a>
                {% elseif selectedBilling %}
                    <div>
                        {{ selectedBilling.fullName }}<br>
                        {{ selectedBilling.line1 }}{% if selectedBilling.line2 %}, {{ selectedBilling.line2 }}{% endif %}<br>
                        {{ selectedBilling.postalCode }} {{ selectedBilling.city }} — {{ selectedBilling.country }}
                    </div>
                    <a class="btn btn-link p-0 mt-2" href="{{ path('checkout_address') }}">changer</a>
                {% else %}
                    <p class="text-muted mb-2">Aucune adresse de facturation sélectionnée.</p>
                    <a class="btn btn-primary btn-sm" href="{{ path('checkout_address') }}">choisir une adresse</a>
                {% endif %}
            </div>
        </div>

        <table class="table align-middle">
            <thead>
            <tr>
                <th style="width:100px;">Photo</th>
                <th>Article</th>
                <th class="text-end">Prix</th>
                <th class="text-center">Qté</th>
                <th class="text-end">Sous-total</th>
            </tr>
            </thead>
            <tbody>
            {% for line in items %}
                {% set _slug = line.article.slug ?? null %}
                {% set mainSrc = vich_uploader_asset(line.article, 'imageFile')
                    ?? (line.article.images|length > 0
                    ? vich_uploader_asset(line.article.images|first, 'file')
                    : asset('images/placeholder.png')) %}

                <tr>
                    <td>
                        <img src="{{ mainSrc }}"
                             alt="{{ line.article.titre }}"
                             style="width:80px;height:80px;object-fit:cover;border-radius:6px;">
                    </td>
                    <td>
                        {% if _slug is not empty %}
                            <a href="{{ path('article_show', { slug: _slug }) }}">{{ line.article.titre }}</a>
                        {% else %}
                            <a href="{{ path('article_show', { id: line.article.id }) }}">{{ line.article.titre }}</a>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ line.price|number_format(2, ',', ' ') }} €</td>
                    <td class="text-center">{{ line.qty }}</td>
                    <td class="text-end">{{ line.subtotal|number_format(2, ',', ' ') }} €</td>
                </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <th colspan="4" class="text-end">Total</th>
                <th class="text-end">{{ total|number_format(2, ',', ' ') }} €</th>
            </tr>
            </tfoot>
        </table>

        {# Choix du moyen de paiement #}
        <div class="card mb-3">
            <div class="card-body">
                <h2 class="h6 mb-3">Moyen de paiement</h2>

                <form id="payment-choice" method="post" action="{{ path('checkout_confirm') }}" target="_blank" rel="noopener">
                    <input type="hidden" name="_token" value="{{ csrf_token('checkout_confirm') }}">

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment_method" id="pay-card" value="card" checked>
                        <label class="form-check-label" for="pay-card">
                            Carte / PayPal (via Stripe)
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="payment_method" id="pay-bank" value="bank_transfer">
                        <label class="form-check-label" for="pay-bank">Virement bancaire</label>

                        <div id="bank-box" class="mt-2" style="display:none;">
                            <div class="p-3" style="background:#f8fbff;border:1px solid #e0edf9;border-radius:6px;">
                                Effectuez le paiement directement depuis votre compte bancaire.
                                Utilisez la <strong>référence de commande</strong> comme libellé du virement.
                                Votre commande ne sera préparée qu’après réception des fonds.
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ path('cart_show') }}" class="btn btn-outline-secondary">← Retour au panier</a>

                        {% if canConfirm %}
                            <button type="submit"
                                    class="btn btn-primary btn-lg"
                                    aria-label="Commander"
                                    title="Commander"
                                    formtarget="_blank">
                                Commander
                            </button>
                        {% else %}
                            <div class="text-end">
                                <div class="alert alert-warning py-2 px-3 mb-2">
                                    {% if not selectedAddress %}
                                        Veuillez choisir une adresse de livraison pour continuer.
                                    {% elseif not billingSame and not selectedBilling %}
                                        Veuillez choisir une adresse de facturation pour continuer.
                                    {% else %}
                                        Informations manquantes pour finaliser la commande.
                                    {% endif %}
                                </div>
                                <a class="btn btn-primary" href="{{ path('checkout_address') }}">Choisir une adresse</a>
                            </div>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script>
        (function () {
            var bank = document.getElementById('pay-bank');
            var card = document.getElementById('pay-card');
            var box  = document.getElementById('bank-box');
            function toggle(){ box.style.display = bank && bank.checked ? 'block' : 'none'; }
            if (bank && card && box) {
                bank.addEventListener('change', toggle);
                card.addEventListener('change', toggle);
                toggle();
            }
        })();
    </script>
{% endblock %}
