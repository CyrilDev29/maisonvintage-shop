{% extends 'base.html.twig' %}
{% block title %}Adresses de livraison et facturation{% endblock %}

{% block body %}
    <div class="container my-4" style="max-width:950px">
        <h1 class="h4 mb-3">Adresse de livraison</h1>

        <div class="row g-4">
            <!-- Bloc gauche : carnet d'adresses -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-body">
                        <h2 class="h6 mb-3">Choisir une adresse de livraison</h2>

                        {% if addresses is not empty %}
                            {# IMPORTANT: pas de forms imbriqués ! #}
                            <form id="shipping-form" method="post" action="{{ path('checkout_address') }}">
                                <input type="hidden" name="action" value="select_shipping">
                                <input type="hidden" name="_token" value="{{ csrf_token('checkout_address_select_shipping') }}">
                                <div class="vstack gap-2">
                                    {% for a in addresses %}
                                        <label class="border rounded p-2 d-flex gap-2 align-items-start">
                                            <input
                                                type="radio"
                                                name="selected_address_id"
                                                value="{{ a.id }}"
                                                {% if selectedId and selectedId == a.id %}checked{% endif %}
                                                required
                                                style="margin-top:6px"
                                            >
                                            <span>
                                            {{ a.fullName }}<br>
                                            {{ a.line1 }}{% if a.line2 %}, {{ a.line2 }}{% endif %}<br>
                                            {{ a.postalCode }} {{ a.city }} — {{ a.country }}
                                        </span>
                                        </label>
                                        <div class="mt-1 ms-4 small">
                                            <a href="{{ path('account_address_edit', {id: a.id, back: 'checkout'}) }}">modifier</a>
                                            {# supprimer: on le fait depuis la page d'édition pour éviter les formulaires imbriqués #}
                                        </div>
                                    {% endfor %}
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-primary">Continuer vers le paiement</button>
                                </div>
                            </form>
                        {% else %}
                            <p class="text-muted">Aucune adresse enregistrée pour le moment.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Bloc facturation -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h2 class="h6 mb-3">Adresse de facturation</h2>

                        <form method="post" action="{{ path('checkout_address') }}" class="mb-3">
                            <input type="hidden" name="action" value="billing_same_toggle">
                            <input type="hidden" name="_token" value="{{ csrf_token('checkout_address_billing_same_toggle') }}">
                            <label class="d-flex align-items-center gap-2">
                                <input type="checkbox" name="billing_same" value="1"
                                       {% if app.session.get('checkout.billing_same', true) %}checked{% endif %}
                                       onchange="this.form.submit()">
                                <span>Utiliser la même adresse que la livraison</span>
                            </label>
                        </form>

                        {% if not app.session.get('checkout.billing_same', true) %}
                            <form method="post" action="{{ path('checkout_address') }}">
                                <input type="hidden" name="action" value="select_billing">
                                <input type="hidden" name="_token" value="{{ csrf_token('checkout_address_select_billing') }}">

                                <div class="vstack gap-2">
                                    {% for a in addresses %}
                                        <label class="border rounded p-2 d-flex gap-2 align-items-start">
                                            <input
                                                type="radio"
                                                name="billing_address_id"
                                                value="{{ a.id }}"
                                                {% if app.session.get('checkout.billing_address_id') and app.session.get('checkout.billing_address_id') == a.id %}checked{% endif %}
                                                required
                                                style="margin-top:6px"
                                            >
                                            <span>
                                            {{ a.fullName }}<br>
                                            {{ a.line1 }}{% if a.line2 %}, {{ a.line2 }}{% endif %}<br>
                                            {{ a.postalCode }} {{ a.city }} — {{ a.country }}
                                        </span>
                                        </label>
                                    {% endfor %}
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-outline-primary">Choisir cette adresse de facturation</button>
                                </div>
                            </form>
                        {% else %}
                            <p class="text-muted mb-0">La facture utilisera l'adresse de livraison sélectionnée.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bloc droit : ajout d'adresse -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-body">
                        <h2 class="h6 mb-3">Ajouter une nouvelle adresse</h2>
                        {{ form_start(addressForm) }}
                        {{ form_row(addressForm.fullName) }}
                        {{ form_row(addressForm.line1) }}
                        {{ form_row(addressForm.line2) }}
                        <div class="row">
                            <div class="col-md-4">{{ form_row(addressForm.postalCode) }}</div>
                            <div class="col-md-8">{{ form_row(addressForm.city) }}</div>
                        </div>
                        {{ form_row(addressForm.country) }}
                        {{ form_row(addressForm.phone) }}
                        <button class="btn btn-outline-secondary mt-2">Enregistrer et continuer</button>
                        {{ form_end(addressForm) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
