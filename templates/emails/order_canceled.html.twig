{# templates/emails/order_canceled.html.twig #}
{#
Email d’alerte : annulation de commande
Variables :
  - order : \App\Entity\Order
  - user  : \App\Entity\User
  - refundedNow : bool (optionnel)
#}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Annulation commande {{ order.reference }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; color:#222; background:#f6f7fb; margin:0; padding:0; }
        .container { max-width:680px; margin:0 auto; background:#ffffff; border:1px solid #e9ecef; border-radius:8px; overflow:hidden; }
        .header { background:#111; color:#fff; padding:16px 20px; font-size:16px; font-weight:bold; }
        .content { padding:20px; }
        .muted { color:#666; font-size:13px; }
        .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; background:#dc3545; color:#fff; }
        .badge-ok { background:#198754; }
        .badge-warn { background:#fd7e14; }
        table { width:100%; border-collapse:collapse; margin-top:12px; }
        th, td { padding:8px; border-bottom:1px solid #eee; font-size:14px; text-align:left; }
        th { background:#f9fafc; }
        .text-right { text-align:right; }
        .total-row td { font-weight:bold; }
        .footer { padding:16px 20px; color:#666; font-size:12px; }
        .small { font-size:12px; color:#555; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        Annulation de commande — {{ order.reference }}
    </div>

    <div class="content">
        <p>
            <span class="badge">ANNULÉE</span>
            {% if refundedNow or order.refundedAt %}
                <span class="badge badge-ok">REMBOURSÉE</span>
            {% else %}
                <span class="badge badge-warn">REMBOURSEMENT À VÉRIFIER</span>
            {% endif %}
        </p>

        <p>
            Bonjour,<br>
            La commande <strong>{{ order.reference }}</strong> a été annulée.
        </p>

        <p class="muted">
            Date de création : {{ order.createdAt|date('d/m/Y H:i') }}<br>
            Client : {{ order.prenom }} {{ order.nom }} — {{ order.user.email }}<br>
            Téléphone : {{ order.telephone }}<br>
            Annulée le : {{ order.canceledAt ? order.canceledAt|date('d/m/Y H:i') : '—' }}
        </p>

        <div class="small" style="margin:10px 0 6px;">
            {% if order.stripePaymentIntentId %}
                PaymentIntent : <span class="mono">{{ order.stripePaymentIntentId }}</span><br>
            {% endif %}
            {% if order.stripeRefundId %}
                Refund ID : <span class="mono">{{ order.stripeRefundId }}</span>
                {% if order.refundedAt %} — le {{ order.refundedAt|date('d/m/Y H:i') }}{% endif %}
                <br>
            {% endif %}
            {% if order.stripeSessionId %}
                Checkout Session : <span class="mono">{{ order.stripeSessionId }}</span>
            {% endif %}
        </div>

        <h3 style="margin:20px 0 8px;">Articles</h3>
        <table role="presentation" aria-hidden="true">
            <thead>
            <tr>
                <th>Produit</th>
                <th class="text-right">PU (€)</th>
                <th class="text-right">Qté</th>
                <th class="text-right">Sous-total (€)</th>
            </tr>
            </thead>
            <tbody>
            {% for item in order.items %}
                {% set unit = (item.unitPrice|replace({',':'.'})) + 0 %}
                {% set qty  = (item.quantity ?? 0) + 0 %}
                {% set sub  = unit * qty %}
                <tr>
                    <td>{{ item.productName }}</td>
                    <td class="text-right">{{ unit|number_format(2, ',', ' ') }}</td>
                    <td class="text-right">{{ qty }}</td>
                    <td class="text-right">{{ sub|number_format(2, ',', ' ') }}</td>
                </tr>
            {% endfor %}
            {% set total_num = (order.total|replace({',':'.'})) + 0 %}
            <tr class="total-row">
                <td colspan="3" class="text-right">Total :</td>
                <td class="text-right">{{ total_num|number_format(2, ',', ' ') }} €</td>
            </tr>
            </tbody>
        </table>

        <h3 style="margin:20px 0 8px;">Adresse de livraison</h3>
        <p class="muted" style="margin-top:0;">
            {{ order.prenom }} {{ order.nom }}<br>
            {{ order.rue }}<br>
            {{ order.codePostal }} {{ order.ville }} — {{ order.pays }}
        </p>
    </div>

    <div class="footer">
        Notification automatique — référence {{ order.reference }}.
    </div>
</div>
</body>
</html>
