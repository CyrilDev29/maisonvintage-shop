{# templates/emails/order_confirmation.html.twig #}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Confirmation de commande</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; color: #333; padding: 20px; }
        .container { background: #ffffff; border: 1px solid #ddd; border-radius: 6px; max-width: 600px; margin: auto; padding: 20px; }
        h2 { color: #2c3e50; margin-top: 0; }
        h3 { margin-bottom: 6px; }
        .addresses { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0 8px; }
        .addr { border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
        .total { font-size: 18px; font-weight: bold; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f1f1f1; text-align: left; }
        .status { background: #e9ecef; padding: 8px; border-radius: 4px; margin-top: 10px; display: inline-block; }
        .button { display: inline-block; padding: 10px 16px; background-color: #2c3e50; color: #fff !important; text-decoration: none; border-radius: 4px; margin-top: 15px; }
        .muted { color: #666; font-size: 12px; }
        .info { margin-top:25px;border:1px solid #cce5ff;background:#f8fbff;padding:15px;border-radius:6px; }
        code { font-family: Consolas, Monaco, monospace; }
        @media (max-width:600px){ .addresses{grid-template-columns:1fr;} }
    </style>
</head>
<body>
<div class="container">
    {# Nom client robuste : shippingSnapshot > (order.prenom/nom) > (user.prenom/nom) > email #}
    {% set _ship = order.shippingSnapshot ?? null %}
    {% set _customer_fallback =
        (order.prenom|default('') ~ ' ' ~ order.nom|default(''))|trim ?: (
        (user.prenom|default('') ~ ' ' ~ user.nom|default(''))|trim ?: (order.user.email|default('Client'))
        ) %}
    {% set customer_name = (_ship and _ship.fullName is defined and _ship.fullName) ? _ship.fullName : _customer_fallback %}

    <h2>Merci pour votre commande, {{ customer_name }} !</h2>

    <p>Votre commande <strong>{{ order.reference }}</strong> a bien été enregistrée.</p>
    <p class="total">Montant total : {{ (order.total|default(0))|number_format(2, ',', ' ') }} €</p>

    <div class="addresses">
        <div class="addr">
            <h3>Adresse de livraison</h3>
            {% if order.shippingSnapshot %}
                <strong>{{ order.shippingSnapshot.fullName }}</strong><br>
                {{ order.shippingSnapshot.line1 }}{% if order.shippingSnapshot.line2 %}, {{ order.shippingSnapshot.line2 }}{% endif %}<br>
                {{ order.shippingSnapshot.postalCode }} {{ order.shippingSnapshot.city }} — {{ order.shippingSnapshot.country }}
                {% if order.shippingSnapshot.phone %}
                    <br><span class="muted">Tél. {{ order.shippingSnapshot.phone }}</span>
                {% endif %}
            {% else %}
                <span class="muted">Non renseignée</span>
            {% endif %}
        </div>
        <div class="addr">
            <h3>Adresse de facturation</h3>
            {% set bill = order.billingSnapshot ?? order.shippingSnapshot %}
            {% if bill %}
                <strong>{{ bill.fullName }}</strong><br>
                {{ bill.line1 }}{% if bill.line2 %}, {{ bill.line2 }}{% endif %}<br>
                {{ bill.postalCode }} {{ bill.city }} — {{ bill.country }}
                {% if bill.phone %}
                    <br><span class="muted">Tél. {{ bill.phone }}</span>
                {% endif %}
            {% else %}
                <span class="muted">Non renseignée</span>
            {% endif %}
        </div>
    </div>

    <h3>Détails de votre commande :</h3>
    <table>
        <thead>
        <tr>
            <th>Produit</th>
            <th style="text-align:center;">Qté</th>
            <th style="text-align:right;">Prix unitaire</th>
            <th style="text-align:right;">Sous-total</th>
        </tr>
        </thead>
        <tbody>
        {% for item in order.items %}
            {% set unit = (item.unitPrice|default(0)|replace({',':'.'})) + 0 %}
            {% set qty  = (item.quantity|default(0)) + 0 %}
            {% set subtotal = unit * qty %}
            <tr>
                <td>{{ item.productName }}</td>
                <td style="text-align:center;">{{ qty }}</td>
                <td style="text-align:right;">{{ unit|number_format(2, ',', ' ') }} €</td>
                <td style="text-align:right;">{{ subtotal|number_format(2, ',', ' ') }} €</td>
            </tr>
        {% else %}
            <tr><td colspan="4" class="muted">Aucune ligne.</td></tr>
        {% endfor %}
        </tbody>
    </table>

    {# Lecture "agnostique" du statut : enum (value/name) ou string, puis normalisation #}
    {% set _status =
        order.status is defined and order.status
        ? (attribute(order.status, 'value') is defined
        ? order.status.value
        : (attribute(order.status, 'name') is defined ? order.status.name : order.status))
        : null
    %}
    {% set _norm = (_status is not null) ? (_status|upper|replace({' ': '_', '-': '_'}) ) : null %}

    <p class="status">
        Statut actuel :
        <strong>{{ _status ?? 'Non défini' }}</strong>
    </p>

    {# --- Virement : encart RIB si EN_ATTENTE* (ex: EN_ATTENTE_DE_PAIEMENT) --- #}
    {% set awaiting = (_norm is not null and _norm starts with 'EN_ATTENTE') %}
    {% if awaiting %}
        {% set _holder   = bank_holder|default('') %}
        {% set _bankname = bank_bankname|default('') %}
        {% set _iban     = bank_iban|default('') %}
        {% set _bic      = bank_bic|default('') %}
        <div class="info">
            <h3 style="margin-top:0;">Informations pour le virement</h3>
            <p>Merci de procéder au règlement par virement bancaire en utilisant les coordonnées suivantes&nbsp;:</p>
            <ul style="list-style:none;padding-left:0;margin:0;">
                <li><strong>Titulaire&nbsp;:</strong> {{ _holder }}</li>
                <li><strong>Banque&nbsp;:</strong> {{ _bankname }}</li>
                <li><strong>IBAN&nbsp;:</strong> <code>{{ _iban }}</code></li>
                <li><strong>BIC&nbsp;:</strong> <code>{{ _bic }}</code></li>
            </ul>
            <p style="margin-top:10px;">
                Indiquez la référence <strong>{{ order.reference }}</strong> dans le libellé du virement.
                La commande sera préparée après réception des fonds.
            </p>
        </div>
    {% endif %}

    {# Boutons utiles #}
    <p style="margin-top:25px;">
        <a href="{{ url('app_account_order_show', { id: order.id }) }}" class="button">Voir ma commande</a>
    </p>

    {# Facture disponible si paiement validé (ou flag forcé) #}
    {% set paid_norms = ['EN_COURS', 'EN_PREPARATION', 'EXPEDIEE', 'LIVREE'] %}
    {% set has_invoice_flag = (order.invoiceSent is defined and order.invoiceSent) %}
    {% set is_invoice_available = (_norm in paid_norms) or has_invoice_flag %}
    {% if is_invoice_available %}
        <p>
            <a href="{{ url('account_order_invoice', { id: order.id }) }}" class="button">
                Télécharger ma facture (PDF)
            </a>
        </p>
    {% endif %}

    <p style="margin-top:25px;">À bientôt,<br>L’équipe Maison Vintage</p>
</div>
</body>
</html>
