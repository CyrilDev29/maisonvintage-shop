{# templates/emails/order_confirmation.html.twig #}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Confirmation de commande</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; color: #333; padding: 20px; }
        .container { background: #ffffff; border: 1px solid #ddd; border-radius: 6px; max-width: 600px; margin: auto; padding: 20px; }
        h2 { color: #2c3e50; margin-top: 0; }
        h3 { margin-bottom: 6px; }
        .addresses { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0 8px; }
        .addr { border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
        .total { font-size: 18px; font-weight: bold; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f1f1f1; text-align: left; }
        .status { background: #e9ecef; padding: 8px; border-radius: 4px; margin-top: 10px; display: inline-block; }
        .button { display: inline-block; padding: 10px 16px; background-color: #2c3e50; color: #fff !important; text-decoration: none; border-radius: 4px; margin-top: 15px; }
        .muted { color: #666; font-size: 12px; }
    </style>
</head>
<body>
<div class="container">
    {% set customer_name =
        (order.shippingSnapshot is defined and order.shippingSnapshot and order.shippingSnapshot.fullName is defined and order.shippingSnapshot.fullName)
        ? order.shippingSnapshot.fullName
        : (user.prenom ~ ' ' ~ user.nom)
    %}

    <h2>Merci pour votre commande, {{ customer_name }} !</h2>

    <p>Votre commande <strong>{{ order.reference }}</strong> a bien été enregistrée.</p>
    <p class="total">Montant total : {{ order.total|number_format(2, ',', ' ') }} €</p>

    <div class="addresses">
        <div class="addr">
            <h3>Adresse de livraison</h3>
            {% if order.shippingSnapshot %}
                <strong>{{ order.shippingSnapshot.fullName }}</strong><br>
                {{ order.shippingSnapshot.line1 }}{% if order.shippingSnapshot.line2 %}, {{ order.shippingSnapshot.line2 }}{% endif %}<br>
                {{ order.shippingSnapshot.postalCode }} {{ order.shippingSnapshot.city }} — {{ order.shippingSnapshot.country }}
                {% if order.shippingSnapshot.phone %}
                    <br><span class="muted">Tél. {{ order.shippingSnapshot.phone }}</span>
                {% endif %}
            {% else %}
                <span class="muted">Non renseignée</span>
            {% endif %}
        </div>
        <div class="addr">
            <h3>Adresse de facturation</h3>
            {% set bill = order.billingSnapshot ?? order.shippingSnapshot %}
            {% if bill %}
                <strong>{{ bill.fullName }}</strong><br>
                {{ bill.line1 }}{% if bill.line2 %}, {{ bill.line2 }}{% endif %}<br>
                {{ bill.postalCode }} {{ bill.city }} — {{ bill.country }}
                {% if bill.phone %}
                    <br><span class="muted">Tél. {{ bill.phone }}</span>
                {% endif %}
            {% else %}
                <span class="muted">Non renseignée</span>
            {% endif %}
        </div>
    </div>

    <h3>Détails de votre commande :</h3>
    <table>
        <thead>
        <tr>
            <th>Produit</th>
            <th style="text-align:center;">Qté</th>
            <th style="text-align:right;">Prix unitaire</th>
            <th style="text-align:right;">Sous-total</th>
        </tr>
        </thead>
        <tbody>
        {% for item in order.items %}
            {% set unit = (item.unitPrice|replace({',':'.'})) + 0 %}
            {% set qty  = (item.quantity ?? 0) + 0 %}
            {% set subtotal = unit * qty %}
            <tr>
                <td>{{ item.productName }}</td>
                <td style="text-align:center;">{{ qty }}</td>
                <td style="text-align:right;">{{ unit|number_format(2, ',', ' ') }} €</td>
                <td style="text-align:right;">{{ subtotal|number_format(2, ',', ' ') }} €</td>
            </tr>
        {% else %}
            <tr><td colspan="4" class="muted">Aucune ligne.</td></tr>
        {% endfor %}
        </tbody>
    </table>

    <p class="status">Statut actuel : <strong>{{ order.status.value }}</strong></p>

    {# Bloc virement seulement si statut EN_ATTENTE_PAIEMENT #}
    {% if order.status is same as(constant('App\\\\Enum\\\\OrderStatus::EN_ATTENTE_PAIEMENT')) %}
        <div style="margin-top:25px;border:1px solid #cce5ff;background:#f8fbff;padding:15px;border-radius:6px;">
            <h3 style="margin-top:0;">Informations pour le virement</h3>
            <p>Merci de procéder au règlement par virement bancaire en utilisant les coordonnées suivantes&nbsp;:</p>
            <ul style="list-style:none;padding-left:0;margin:0;">
                <li><strong>Titulaire&nbsp;:</strong> {{ bank_holder }}</li>
                <li><strong>Banque&nbsp;:</strong> {{ bank_bankname }}</li>
                <li><strong>IBAN&nbsp;:</strong> <code>{{ bank_iban }}</code></li>
                <li><strong>BIC&nbsp;:</strong> <code>{{ bank_bic }}</code></li>
            </ul>
            <p style="margin-top:10px;">
                Indiquez la référence <strong>{{ order.reference }}</strong> dans le libellé du virement.
                La commande sera préparée après réception des fonds.
            </p>
        </div>
    {% endif %}

    <p style="margin-top:25px;">
        Vous pouvez également télécharger votre facture à tout moment depuis votre espace client :
        <br>
        <a href="{{ url('order_invoice_pdf', { id: order.id }) }}" class="button">
            Télécharger ma facture (PDF)
        </a>
    </p>

    <p style="margin-top:25px;">À bientôt,<br>L’équipe Maison Vintage</p>
</div>
</body>
</html>
